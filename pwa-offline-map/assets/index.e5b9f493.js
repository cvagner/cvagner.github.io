import{v as V,n as M,G as P,F as y,S as U,C as z,a as N,b as R,P as j,V as E,c as C,D as F,f as B,M as Z,d as A,e as W,g as _,h as D,W as H,i as q,T as K}from"./vendor.b2399feb.js";function de(){import("data:text/javascript,")}const $=function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerpolicy&&(i.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?i.credentials="include":t.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(t){if(t.ep)return;t.ep=!0;const i=n(t);fetch(t.href,i)}};$();function X(e={}){const{immediate:o=!1,onNeedRefresh:n,onOfflineReady:r,onRegistered:t,onRegisterError:i}=e;let a,c;const d=async(s=!0)=>{s&&(a==null||a.addEventListener("controlling",w=>{w.isUpdate&&window.location.reload()})),c&&c.waiting&&await M(c.waiting,{type:"SKIP_WAITING"})};if("serviceWorker"in navigator){a=new V("./sw.js",{scope:"./",type:"classic"}),a.addEventListener("activated",s=>{s.isUpdate||r==null||r()});{const s=()=>{n==null||n()};a.addEventListener("waiting",s),a.addEventListener("externalwaiting",s)}a.register({immediate:o}).then(s=>{c=s,t==null||t(s)}).catch(s=>{i==null||i(s)})}return d}async function Y(e,o){caches.match(o,{cacheName:"orthophotos"}).then(n=>{if(!(n!=null&&n.blob)){e.getImage().src=o;return}n.blob().then(r=>{const t=URL.createObjectURL(r);e.getImage().onload=()=>URL.revokeObjectURL(t),e.getImage().src=t})})}function J(){caches.delete("orthophotos")}function Q(e,o,n){let r=[],t=n.getTileGrid().getMaxZoom();for(let i=Math.min(t,Math.floor(o));i<=t;i++)n.getTileGrid().forEachTileCoord(e,parseInt(i),a=>r.push(n.getTileUrlFunction()(a)));return r}let T=100,I=1;function x(e){return Math.ceil(e.length/T)*I}async function L(e){for(;;){let o=e.splice(0,T);if(o.length<=0)break;ee(o),await te(I*1e3)}}async function ee(e){await(await window.caches.open("orthophotos")).addAll(e)}function te(e){return new Promise(o=>setTimeout(o,e))}let f,l;function ne(e){f=e,l=new P({trackingOptions:{enableHighAccuracy:!0},projection:f.getView().getProjection()}),l.on("error",r=>console.log(r.message));let o=new y;l.on("change:accuracyGeometry",function(){o.setGeometry(l.getAccuracyGeometry())});let n=new y;n.setStyle(new U({image:new z({radius:6,fill:new N({color:"#3399CC"}),stroke:new R({color:"#fff",width:2})})})),l.on("change:position",function(){const r=l.getPosition();n.setGeometry(r?new j(r):null)}),new E({map:f,source:new C({features:[o,n]})})}function G(e){l.setTracking(e)}function S(){let e=l.getPosition();if(e){f.getView().setCenter(e);let o=f.getView().getZoom();f.getView().setZoom(Math.max(o,16))}else l.once("change:position",()=>S()),G(!0)}const p=10;let u,m;function oe(e,o){u=e,m=new C,u.addLayer(new E({source:m}));const n=new F({type:"LineString",stopClick:!0});n.setActive(!1),u.addInteraction(n),n.on("drawend",c=>{n.setActive(!1);const d=c.feature.getGeometry(),s=u.getView().getZoom();if(s<p){alert("Un nombre trop important de tuiles serait mis en cache \xE0 cette \xE9chelle. Veuillez zoomer");return}const w=ie(d,s,o);m.addFeatures(w)});const r=document.createElement("span");r.textContent=" | ",document.getElementsByClassName("toolbar")[0].appendChild(r);const t=document.createElement("button");t.id="load-cache-intersecting",t.title="une ligne pour identifier les tuiles \xE0 conserver",t.textContent="\u2710 Dessiner",t.onclick=function(){if(u.getView().getZoom()<p){alert("Un nombre trop important de tuiles serait mis en cache \xE0 cette \xE9chelle. Veuillez zoomer");return}n.setActive(!0),m.clear()},document.getElementsByClassName("toolbar")[0].appendChild(t);const i=document.createElement("button");i.id="load-cache-intersecting",i.title="les tuiles identifi\xE9es",i.textContent="\u2605 Conserver",i.onclick=function(){const c=m.getFeatures();c.length<=0||!confirm(c.length+" tuiles seront mises en cache ("+x(c)+" sec avec la fibre environ). Continuer ?")||(L(re(c)),m.clear())},document.getElementsByClassName("toolbar")[0].appendChild(i);function a(){const c=u.getView().getZoom();i.disabled=t.disabled=c<p}u.getView().on("change:resolution",c=>{const d=u.getView().getZoom();i.disabled=t.disabled=d<p}),a()}function ie(e,o,n){const r=[],t=e.getExtent();let i=n.getTileGrid().getMaxZoom();for(let a=Math.min(i,Math.floor(o));a<=i;a++)n.getTileGrid().forEachTileCoord(t,parseInt(a),c=>{const d=n.getTileGrid().getTileCoordExtent(c),s=B(d);e.intersectsExtent(s.getExtent())&&r.push(new y({geometry:s,tileUrl:n.getTileUrlFunction()(c)}))});return r}function re(e){return e.map(o=>o.getProperties().tileUrl)}const ae=X({onNeedRefresh(){confirm("Une version plus r\xE9cente de l'application est disponible. Recharger ?")&&ae()},onOfflineReady(){alert("L'application est pr\xEAte \xE0 fonctionner sans r\xE9seau.")}});document.querySelector("#app").innerHTML=`
  <h1>Photographies a\xE9riennes <span id="status"></span></h1>
  <div class="toolbar">
    <span>Position</span>
    <button id="position" title="Suivre la position"><span id="positionIcon">\u2715</span> Suivre</button>
    <button id="center-position" title="Centrer sur la position">\u2316 Centrer</button>
    <button id="goto-dijon" title="Dijon">\u{1F989} Dijon</button>
    <br/>
    <span>Cache</span>
    <button id="load-cache" title="du niveau de zoom courant au plus grand">\u2605 Carte</button>
    <button id="clear-cache">\u2606 Vider</button>
  </div>
  <div id="map" class="map"></div>
`;document.getElementById("load-cache").onclick=function(){let e=g.getView().calculateExtent(g.getSize()),o=g.getView().getZoom();if(o<15){alert("Un nombre trop important de tuiles serait mis en cache \xE0 cette \xE9chelle. Veuillez zoomer");return}let n=Q(e,o,v);n.length>200&&!confirm(n.length+" tuiles seront mises en cache ("+x(n)+" sec avec la fibre environ). Continuer ?")||L(n)};document.getElementById("clear-cache").onclick=J;document.getElementById("goto-dijon").onclick=function(){let e=[561156.3584244443,5998685964885023e-9,561713.7014265041,5998807655496827e-9];g.getView().fit(e)};let h=!1,ce=document.getElementById("positionIcon");document.getElementById("position").onclick=function(){h=!h,G(h),ce.innerText=h?"\u2713":"\u2715"};document.getElementById("center-position").onclick=S;window.addEventListener("online",b);window.addEventListener("offline",b);function b(){let e=document.getElementById("status");e&&(e.innerText=navigator.onLine?"\u26A1":"\u{1F4A4}")}b();const g=new Z({target:"map",view:new A({zoom:5,center:W([5,45])})}),k=[],O=[],se=_("EPSG:3857"),le=D(se.getExtent())/256;for(let e=0;e<20;e++)O[e]=e.toString(),k[e]=le/Math.pow(2,e);const ue=new H({origin:[-20037508,20037508],resolutions:k,matrixIds:O}),v=new q({url:"https://data.geopf.fr/wmts",layer:"ORTHOIMAGERY.ORTHOPHOTOS",matrixSet:"PM",format:"image/jpeg",projection:"EPSG:3857",tileGrid:ue,style:"normal",attributions:`<a href="https://www.ign.fr/" target="_blank"><img src="https://wxs.ign.fr/static/logos/IGN/IGN.gif" title="Institut national de l'information g\xE9ographique et foresti\xE8re" alt="IGN"></a>`,tileLoadFunction:Y});g.addLayer(new K({source:v}));ne(g);oe(g,v);export{de as __vite_legacy_guard};
