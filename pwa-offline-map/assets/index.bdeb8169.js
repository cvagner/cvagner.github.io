import{v as R,n as B,G as Z,F as b,S as W,C as _,a as D,b as H,P as q,V as v,c as x,D as J,f as K,d as $,e as X,M as Y,g as Q,h as ee,i as te,j as ne,W as oe,k as ie,T as re}from"./vendor.22f9aeeb.js";function Te(){import("data:text/javascript,")}const ae=function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerpolicy&&(o.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?o.credentials="include":t.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}};ae();function se(e={}){const{immediate:i=!1,onNeedRefresh:n,onOfflineReady:r,onRegistered:t,onRegisterError:o}=e;let a,s;const l=async(c=!0)=>{c&&(a==null||a.addEventListener("controlling",p=>{p.isUpdate&&window.location.reload()})),s&&s.waiting&&await B(s.waiting,{type:"SKIP_WAITING"})};if("serviceWorker"in navigator){a=new R("./sw.js",{scope:"./",type:"classic"}),a.addEventListener("activated",c=>{c.isUpdate||r==null||r()});{const c=()=>{n==null||n()};a.addEventListener("waiting",c),a.addEventListener("externalwaiting",c)}a.register({immediate:i}).then(c=>{s=c,t==null||t(c)}).catch(c=>{o==null||o(c)})}return l}let g,d;function ce(e){g=e,d=new Z({trackingOptions:{enableHighAccuracy:!0},projection:g.getView().getProjection()}),d.on("error",r=>console.log(r.message));let i=new b;d.on("change:accuracyGeometry",function(){i.setGeometry(d.getAccuracyGeometry())});let n=new b;n.setStyle(new W({image:new _({radius:6,fill:new D({color:"#3399CC"}),stroke:new H({color:"#fff",width:2})})})),d.on("change:position",function(){const r=d.getPosition();n.setGeometry(r?new q(r):null)}),new v({map:g,source:new x({features:[i,n]})})}function T(e){d.setTracking(e)}function G(){let e=d.getPosition();if(e){g.getView().setCenter(e);let i=g.getView().getZoom();g.getView().setZoom(Math.max(i,16))}else d.once("change:position",()=>G()),T(!0)}function le(e,i){const n=document.getElementsByClassName("toolbar")[0],r=document.createElement("span");r.textContent="Cache ",n.appendChild(r);const t=document.createElement("button");t.id="load-cache",t.title="du niveau de zoom courant au plus grand",t.textContent="\u2605 Carte",n.appendChild(t),t.onclick=function(){let a=e.getView().calculateExtent(e.getSize()),s=e.getView().getZoom();if(s<15){alert("Un nombre trop important de tuiles serait mis en cache \xE0 cette \xE9chelle. Veuillez zoomer");return}let l=me(a,s,i);l.length<=0||!confirm(l.length+" tuiles seront mises en cache ("+S(l)+" sec avec la fibre environ). Continuer ?")||k(l)};const o=document.createElement("button");o.id="clear-cache",o.title="le cache de tuiles",o.textContent="\u2606 Vider",o.onclick=de,n.appendChild(o)}async function ue(e,i){caches.match(i,{cacheName:"orthophotos"}).then(n=>{if(!(n!=null&&n.blob)){e.getImage().src=i;return}n.blob().then(r=>{const t=URL.createObjectURL(r);e.getImage().onload=()=>URL.revokeObjectURL(t),e.getImage().src=t})})}function de(){caches.delete("orthophotos")}function me(e,i,n){let r=[],t=n.getTileGrid().getMaxZoom();for(let o=Math.min(t,Math.floor(i));o<=t;o++)n.getTileGrid().forEachTileCoord(e,parseInt(o),a=>r.push(n.getTileUrlFunction()(a)));return r}let I=100,L=1;function S(e){return Math.ceil(e.length/I)*L}async function k(e){for(;;){let i=e.splice(0,I);if(i.length<=0)break;ge(i),await fe(L*1e3)}}async function ge(e){await(await window.caches.open("orthophotos")).addAll(e)}function fe(e){return new Promise(i=>setTimeout(i,e))}const h=10;let u,m;function pe(e,i){u=e,m=new x,u.addLayer(new v({source:m}));const n=new J({type:"LineString",stopClick:!0});n.setActive(!1),u.addInteraction(n),n.on("drawend",s=>{n.setActive(!1);const l=s.feature.getGeometry(),c=u.getView().getZoom();if(c<h){alert("Un nombre trop important de tuiles serait mis en cache \xE0 cette \xE9chelle. Veuillez zoomer");return}const p=O(l,c,i);m.addFeatures(p)}),we(i);const r=document.getElementsByClassName("toolbar")[0],t=document.createElement("button");t.id="load-cache-intersecting",t.title="une ligne pour identifier les tuiles \xE0 conserver",t.textContent="\u2710 Dessiner",t.onclick=function(){if(u.getView().getZoom()<h){alert("Un nombre trop important de tuiles serait mis en cache \xE0 cette \xE9chelle. Veuillez zoomer");return}n.setActive(!0),m.clear()},r.appendChild(t);const o=document.createElement("button");o.id="load-cache-intersecting",o.title="les tuiles identifi\xE9es",o.textContent="\u2605 Conserver",o.onclick=function(){const s=m.getFeatures();s.length<=0||!confirm(s.length+" tuiles seront mises en cache ("+S(s)+" sec avec la fibre environ). Continuer ?")||(k(he(s)),m.clear())},r.appendChild(o);function a(){const s=u.getView().getZoom();o.disabled=t.disabled=s<h}u.getView().on("change:resolution",s=>{const l=u.getView().getZoom();o.disabled=t.disabled=l<h}),a()}function O(e,i,n){const r=[],t=e.getExtent();let o=n.getTileGrid().getMaxZoom();for(let a=Math.min(o,Math.floor(i));a<=o;a++)n.getTileGrid().forEachTileCoord(t,parseInt(a),s=>{const l=n.getTileGrid().getTileCoordExtent(s),c=K(l);e.intersectsExtent(c.getExtent())&&r.push(new b({geometry:c,tileUrl:n.getTileUrlFunction()(s)}))});return r}function he(e){return e.map(i=>i.getProperties().tileUrl)}function we(e){const i=document.getElementsByClassName("toolbar")[0],n=document.createElement("input");n.setAttribute("type","file"),n.setAttribute("id","uploadfile"),n.setAttribute("class","uploadfile"),n.setAttribute("accept",".geojson"),i.appendChild(n);const r=document.createElement("label");r.setAttribute("for","uploadfile"),r.setAttribute("title","T\xE9l\xE9verser un fichier geojson"),r.innerHTML="&nbsp;&nbsp;\u21A5&nbsp;&nbsp;";const t=document.createElement("button");i.appendChild(t),t.appendChild(r),n.addEventListener("change",o=>{const a=o.target.files[0];if(a){m.clear();const s=new FileReader;s.onload=function(l){const c=JSON.parse(l.target.result),P=new $().readFeatures(c).map(z=>z.getGeometry()),E=new X(P),j=E.getExtent();u.getView().fit(j,{duration:.2});const N=u.getView().getZoom(),U=O(E,N,e);m.addFeatures(U)},s.readAsText(a)}})}const be=se({onNeedRefresh(){confirm("Une version plus r\xE9cente de l'application est disponible. Recharger ?")&&be()},onOfflineReady(){alert("L'application est pr\xEAte \xE0 fonctionner sans r\xE9seau.")}});document.querySelector("#app").innerHTML=`
  <h1>Photographies a\xE9riennes <span id="status"></span></h1>
  <div class="toolbar">
    <span>Position</span>
    <button id="position" title="Suivre la position"><span id="positionIcon">\u2715</span> Suivre</button>
    <button id="center-position" title="Centrer sur la position">\u2316 Centrer</button>
    <button id="goto-dijon" title="Dijon">\u{1F989} Dijon</button>
  </div>
  <div id="map" class="map"></div>
`;document.getElementById("goto-dijon").onclick=function(){let e=[561156.3584244443,5998685964885023e-9,561713.7014265041,5998807655496827e-9];f.getView().fit(e)};let w=!1,ye=document.getElementById("positionIcon");document.getElementById("position").onclick=function(){w=!w,T(w),ye.innerText=w?"\u2713":"\u2715"};document.getElementById("center-position").onclick=G;window.addEventListener("online",y);window.addEventListener("offline",y);function y(){let e=document.getElementById("status");e&&(e.innerText=navigator.onLine?"\u26A1":"\u{1F4A4}")}y();const f=new Y({target:"map",view:new Q({zoom:5,center:ee([5,45])})}),V=[],F=[],Ce=te("EPSG:3857"),Ee=ne(Ce.getExtent())/256;for(let e=0;e<20;e++)F[e]=e.toString(),V[e]=Ee/Math.pow(2,e);const ve=new oe({origin:[-20037508,20037508],resolutions:V,matrixIds:F}),C=new ie({url:"https://data.geopf.fr/wmts",layer:"ORTHOIMAGERY.ORTHOPHOTOS",matrixSet:"PM",format:"image/jpeg",projection:"EPSG:3857",tileGrid:ve,style:"normal",attributions:`<a href="https://www.ign.fr/" target="_blank"><img src="https://wxs.ign.fr/static/logos/IGN/IGN.gif" title="Institut national de l'information g\xE9ographique et foresti\xE8re" alt="IGN"></a>`,tileLoadFunction:ue});f.addLayer(new re({source:C}));ce(f);const M=document.getElementsByClassName("toolbar")[0];M.appendChild(document.createElement("br"));le(f,C);const A=document.createElement("span");A.textContent=" | ";M.appendChild(A);pe(f,C);export{Te as __vite_legacy_guard};
